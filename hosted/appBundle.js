(()=>{"use strict";const e=(e,t,n,a,o,l,c=!0)=>{a&&(o*=-1),c&&n.clearRect(0,0,640,480),n.save(),n.beginPath(),n.arc(e,t-3*o,3,0,2*Math.PI),n.moveTo(e,t),n.lineTo(e,t+5*o),n.lineTo(e-2*o,t+8*o),n.moveTo(e,t+5*o),n.lineTo(e+2*o,t+8*o),n.moveTo(e-3*o,t+3*o),n.lineTo(e+3*o,t+3*o),l&&(n.strokeStyle=l),n.stroke(),n.closePath(),n.restore()},t=(e,t,n,a,o,l,c)=>{o.save(),o.beginPath(),o.moveTo(e,t),o.lineTo(e+n,t),o.lineTo(e+n,t+a),o.lineTo(e,t+a),o.closePath(),c?(o.fillStyle=l,o.fill()):(o.strokeStyle=l,o.lineWidth=3,o.stroke()),o.restore()};class n{constructor(e,t,n,a,o){this.x=e,this.y=t,this.width=n,this.height=a,this.color=o,this.hSpeed=a*n/15,this.vSpeed=0}}let a=[],o=[],l=[];const c=async(e,t)=>{const n=`name=${e}&item=${t}`;(async e=>{let t;switch(e.status){case 200:t=await e.json();break;case 204:break;default:console.error(t)}})(await fetch("/updateItems",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:n}))};let s,i,r;const d=[];let h={},m={},y=0;const p={screwattack:document.getElementById("screwattack"),morphball:document.getElementById("morphball"),yellowswitch:document.getElementById("yellowswitch")},w={screwattack:{obtained:!1,collected:F},morphball:{obtained:!1,collected:D},yellowswitch:{collected:G},fire:{collected:D}},u={x:-450,y:690,halfWidth:4,halfHeight:7,newX:300,newY:300,scale:1,name:"",flip:!1};let f,g,v,b,x=0,k=0,T=!0,E=!1,S=!1,M=!1,I=!1,$=0,C=[],H=0,B=0,L=0;const j=()=>{S?G():(W(),e(u.x+B,u.y+L,i,u.flip,u.scale)),O()},W=()=>{let e=0,t=0;C[65]&&(e=-2),C[68]&&(e=2),t=u.flip?-3:3,M?C[87]&&(L-=((e,t)=>{let n=4,a=0;return t&&(n=-4),1===e.scale?(e.scale=.1,e.halfWidth=1,e.halfHeight=1,a=-n):(e.scale=1,e.halfWidth=4,e.halfHeight=7,a=-3*n),e.y+=a,a})(u,u.flip),M=!1,$=30,e=0,t=0):I&&($-=1,$<=0&&(M=!0)),u.newX=u.x+e,u.newY=u.y+t,A(u,e,t)?(B+=u.x-u.newX,L+=u.y-u.newY,u.x=u.newX,u.y=u.newY):(u.x+=e,u.y+=t,B-=e,L-=t),R(u)},O=()=>{a.forEach((e=>{t(e.x+B,e.y+L,e.width,e.height,i,e.color,!0)})),o.forEach((e=>{"fire"!==e.id&&i.drawImage(p[e.id],e.x+B,e.y+L)}))},P=()=>{r.clearRect(0,0,640,480),t(0,0,f,g,r,"white",!0),H+=0,d.forEach((function(e){e.hSpeed=1*Math.cos(H),e.vSpeed=1*Math.sin(H),e.x+=e.hSpeed,e.y+=e.vSpeed,e.x>f+20?e.x=-20:e.x<-20&&(e.x=f+20),e.y>g+20?e.y=-20:e.y<-20&&(e.y=g+20),t(e.x,e.y,e.width,e.height,r,e.color,!0)}))},X=async()=>{h&&!S&&(m=await(async e=>{const t=`movement=${JSON.stringify(e)}`;let n=await fetch("/addMovement",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t}),a=await n.json();switch(n.status){case 200:case 204:break;default:console.error(a)}return a})(h),y=0,h.movement=[])},Y=()=>{if(S)return;let t;h.movement.push({x:u.x+u.halfWidth,y:u.y+u.halfHeight,flipped:u.flip}),m.movement&&(t=Object.keys(m.movement),t.splice(t.indexOf(u.name),1),t.length<1||(s.clearRect(0,0,640,480),t.forEach((t=>{const n=m.movement[t].movement[y];n&&e(n.x+B,n.y+L,s,n.flipped,1,`${m.movement[t].color}55`,!1)})),y+=1))},A=(e,t,n)=>{let o=!1;return a.forEach((a=>{q(e,a)&&(o=!0,(((e,t)=>e.y+(e.halfHeight-2)<t.y&&e.newY+(e.halfHeight+2)>=t.y)(e,a)||((e,t)=>e.y-(e.halfHeight-2)>=t.y+t.height&&e.newY-(e.halfHeight+2)<t.y+t.height)(e,a))&&(e.newY-=n,E||(T=!0)),(((e,t)=>e.x-(e.halfWidth-2)>=t.x+t.width&&e.newX-(e.halfWidth+2)<t.x+t.width)(e,a)||((e,t)=>e.x+(e.halfWidth-2)<=t.x&&e.newX+(e.halfWidth+2)>=t.x)(e,a))&&(e.newX-=t))})),o},q=(e,t)=>e.newX-e.halfWidth<t.x+t.width&&e.newX+e.halfWidth>t.x&&e.newY-e.halfHeight<t.y+t.height&&e.newY+e.halfHeight>t.y,R=e=>{o.forEach((t=>{q(e,t)&&(w[t.id].collected(),"fire"!==t.id&&o.splice(o.indexOf(t),1))}))};function D(e=!0){document.getElementById("morphball").style.display="inline",document.getElementById("moveInstructions").innerHTML="Use '<strong>A</strong>', '<strong>D</strong>', and '<strong>W</strong>' to move, ",M=!0,I=!0,!0===e&&(c(u.name,"morphball"),b.play())}function F(e=!0){document.getElementById("screwattack").style.display="inline",document.getElementById("spaceInstructions").innerHTML="<strong>SPACE</strong> to ultra flip",E=!0,!0===e&&(c(u.name,"screwattack"),b.play())}const _=()=>{u.x=300,u.y=300,u.flip=!1,u.newX=300,u.newY=300,B=0,L=0};function G(){S||(d.push(new n(640*Math.random(),480*Math.random(),10*Math.random()+30,4*Math.random()+3,x)),(async(e="#000000")=>{const t=`color=${e}`;await fetch("/addCloud",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t})})(x),v.play(),S=!0),k<254&&(k+=.2,u.y+=.5),e(u.x+B,u.y+L,i,u.flip,u.scale,`#000000${(255-k).toString(16).substring(0,2)}`),d.forEach((e=>{d.indexOf(e)!=d.length-1?e.color=`rgba(${k}, ${k}, ${k}, 0.1)`:e.color=`${x}${k.toString(16).substring(0,2)}`})),a.forEach((e=>{e.color=`rgba(${k}, ${k}, ${k}, 0.5)`}))}const N=e=>{switch(e.keyCode){case 65:case 68:C[e.keyCode]=!0;break;case 87:M&&(C[e.keyCode]=!0);break;case 32:e.preventDefault(),C[e.keyCode]||(T||E)&&(u.flip=!u.flip,T=!1),C[e.keyCode]=!0}},J=e=>{switch(e.keyCode){case 65:case 68:case 87:case 32:C[e.keyCode]=!1}},U=async(t,a)=>{const o=document.querySelector("#createResponse");let c=!0;switch(t.status){case 200:o.innerHTML=`<b>Logged in as existing user ${a}</b>`;break;case 201:o.innerHTML=`<b>Now playing as new player ${a}</b>`;break;case 400:o.innerHTML="<b>Bad Login Request</b>",c=!1;break;default:o.innerHTML="Error code not implemented by client.",c=!1}const m=await t.json();if(m.message&&(o.innerHTML+=`<p>${m.message}</p>`),c){const t=document.getElementById("submitBtn");t.value="Logged in",t.disabled=!0,document.getElementById("resetBtn").disabled=!1,m&&((t,a)=>{t&&t.player?(u.name=t.player.name,x=t.player.color,t.player.items&&(e=>{e.morphball&&D(!1),e.screwattack&&F(!1)})(t.player.items)):u.name=a,h.name=u.name,h.color=x,h.movement=[],v=new Audio("buttonClick.wav"),v.volume=.25,b=new Audio("itemGet.wav"),b.volume=.25;let o=document.querySelector("#canvas_player"),c=document.querySelector("#canvas_walkers"),m=document.querySelector("#canvas_bg");document.getElementById("resetBtn").onclick=_,s=c.getContext("2d"),i=o.getContext("2d"),r=m.getContext("2d"),f=c.width,g=c.height,document.addEventListener("keydown",N),document.addEventListener("keyup",J),e(300,300,i,!1),l&&l.length>0&&l.forEach((e=>{d.push(new n(630*Math.random()+5,470*Math.random()+5,10*Math.random()+30,4*Math.random()+3,e))}));for(let e=0;e<10;e++)d.push(new n(640*Math.random(),480*Math.random(),10*Math.random()+30,4*Math.random()+3,"rgba(0,0,0,0.3)"));P(),s.fillStyle="black",u.x=u.y=300,setInterval(j,1e3/60),setInterval(P,1e3/15),setInterval(X,1e3),setInterval(Y,1e3/30)})(m,a)}};window.onload=()=>{(async()=>{let e=await fetch("/getLevel",{method:"GET",headers:{Accept:"application/json"}});const t=await e.json();t.level&&t.level.rects&&t.level.specialObjects&&(a=t.level.rects,o=t.level.specialObjects),t.level.clouds&&t.level.clouds.length>0&&(l=[...t.level.clouds])})();const e=document.querySelector("#playerForm");e.addEventListener("submit",(t=>(t.preventDefault(),(async e=>{const t=e.querySelector("#nameField").value,n=`name=${t}&age=&color=${e.querySelector("#colorField").value}`;let a=await fetch("/addPlayer",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:n});U(a,t)})(e),!1)))}})();